# 03. 거래 생명주기: 자금 이체 흐름 (Transfer Flow)

자금 이체(`Transfer`) 하나가 요청되고 처리되어 원장에 기록되기까지의 과정은 다음과 같은 명확한 생명주기를 따릅니다. 이 모든 과정은 `TransferService.kt` 에 의해 오케스트레이션됩니다.

## 1. 이체 요청 (Request)

- 사용자는 API를 통해 출금 계좌, 입금 계좌, 금액을 담아 이체를 요청합니다.
- 이 요청은 내부적으로 `TransferCommand` 객체로 변환되어 처리 로직에 전달됩니다.

## 2. 유효성 검증 (Validation)

- 시스템은 이체가 가능한지 여러 조건을 검증합니다.
    - 출금 계좌와 입금 계좌가 모두 `ACTIVE` 상태인지?
    - 출금 계좌의 잔액이 요청된 금액보다 충분한지?
    - 자기 자신에게 이체하는 요청은 아닌지?
- 검증에 실패하면, 거래는 `FAILED` 상태로 즉시 종료됩니다.

## 3. 원장 기록 (Ledger Entry Posting) - (DB Transaction)

- 유효성 검증을 통과하면, 데이터베이스 트랜잭션이 시작됩니다. 이 트랜잭션 안에서 아래의 모든 작업이 원자적(atomic)으로 실행됩니다.
    1.  **Transfer 기록 생성**: 현재 이체 요청에 대한 `Transfer` 객체를 `PENDING` 상태로 데이터베이스에 기록합니다.
    2.  **출금 (Credit Entry)**: 출금 계좌에 대해 `CREDIT` 타입의 `LedgerEntry`를 생성하고 기록합니다.
    3.  **입금 (Debit Entry)**: 입금 계좌에 대해 `DEBIT` 타입의 `LedgerEntry`를 생성하고 기록합니다.
    4.  **계좌 잔액 업데이트**: 출금 계좌의 잔액을 감소시키고, 입금 계좌의 잔액을 증가시킵니다.
- 이 과정 중 하나라도 실패하면, 전체 데이터베이스 트랜잭션이 롤백(Rollback)되어 아무 일도 없었던 상태로 돌아갑니다.

## 4. 최종 상태 업데이트 (Finalization)

- 데이터베이스 트랜잭션이 성공적으로 커밋(Commit)되면,
- `Transfer` 객체의 상태를 `COMPLETED` 로 업데이트하여 거래가 성공적으로 완료되었음을 기록합니다.
- 만약 처리 과정에서 예상된 오류(예: 잔액 부족)가 발생했다면 `FAILED` 상태로 업데이트됩니다.

이러한 단계적인 흐름과 트랜잭션 처리를 통해 시스템은 어떤 상황에서도 데이터의 일관성과 정합성을 보장합니다. `TransactionExecutor.kt`는 이러한 트랜잭션 경계를 설정하는 역할을 담당합니다.
